<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.base.sr.dao.SR0140WDAO">

	<!-- SPP 결재함 목록 조회 -->
    <select id="select01" parameterType="java.util.Map" resultType="java.util.Map">
    	/* SR0140WDAO >> select01 */
	    SELECT
			  '0' AS CHK
			, '' AS ROWFLAG
			, A.REQ_ID			-- 요청서 ID
			, A.REQ_EM_YN		-- 긴급여부
			, A.WF_PROC_CD		-- 현재단계
			, A.MAP_WF_PROC_CD   --매핑진행단계
			, 'APV'  AS SAVE_GUBUN
			, REPLACE(A.WF_PROC_NM, '\n', ' ') AS WF_PROC_NM   --진행단계명
			, A.REQ_STAT_CD		-- 요청서 진행상태
			, A.REQ_STAT_NM || CASE WHEN A.LAST_RTRN_YN = 'Y' THEN '(반려)' END	AS REQ_STAT_NM	--요청서진행상태명
			, A.TITLE			-- 요청서제목
			, A.REQ_USER_ID		-- 요청자ID
			, A.REQ_USER_NM		-- 요청자명
			, A.REQ_DEPT_CD		-- 요청자부서
			, A.REQ_DEPT_NM		-- 요청자부서명
			, A.REQ_DATE		-- 요청일시
			, TO_CHAR(TO_DATE(REQ_DATE, 'YYYYMMDDHH24MISS'), 'YYYY-MM-DD HH24:MI:SS')  AS REQ_DATE_NM
			, A.REQ_WISH_DT		-- 완료희망일
			, A.REQ_WISH_TIME	-- 완료희망 시/분
            , CASE
                WHEN A.REQ_WISH_DT IS NOT NULL
                THEN RPAD((A.REQ_WISH_DT || NVL(A.REQ_WISH_TIME, '2359')), 14, '0')
                ELSE ''
              END   AS REQ_WISH_DT_NM       -- 완료희망일시명

			, B.REQ_TMPLAT_ID
			, B.REQ_TMPLAT_VER
			, B.REQ_TMPLAT_NM	-- 요청서 양식명
			
			, (SELECT ITM_VAL_1 FROM FOMM_CMM_CD_MT WHERE CODE_DIV = 'WORKFLOW_CD' AND UP_CMM_CD = 'REQ_INFO_TYPE_CD' AND CMM_CD = B.REQ_INFO_TYPE_CD AND LANG_CD = 'KR')    AS SR_INFO_URL  --요청서 기본정보 화면 URL
			, B.REQ_URL																														--요청서URL
			, B.ATTACH_USE_YN																												--첨부파일 사용여부
			, B.SVC_CD			-- 서비스
			, B.SVC_DTL_CD		-- 서비스상세
			, (SELECT CMM_CD_NM FROM FOMM_CMM_CD_MT WHERE CODE_DIV = 'WORKFLOW_CD' AND UP_CMM_CD = 'SVC_CD' AND CMM_CD = B.SVC_CD AND LANG_CD = 'KR')
              ||
              CASE
                WHEN B.SVC_DTL_CD IS NOT NULL
                THEN
                    ' > '|| (SELECT CMM_CD_NM FROM FOMM_CMM_CD_MT WHERE CODE_DIV = 'WORKFLOW_CD' AND UP_CMM_CD = B.SVC_CD AND CMM_CD = B.SVC_DTL_CD AND LANG_CD = 'KR')
              END   AS SVC_CD_NM    -- 서비스 > 서비스상세
            , (SELECT CMM_CD_NM FROM FOMM_CMM_CD_MT WHERE CODE_DIV = 'WORKFLOW_CD' AND UP_CMM_CD = 'SVC_CD' AND CMM_CD = B.SVC_CD AND LANG_CD = 'KR') AS SVC_CD_NM1
            , (SELECT CMM_CD_NM FROM FOMM_CMM_CD_MT WHERE CODE_DIV = 'WORKFLOW_CD' AND UP_CMM_CD = B.SVC_CD AND CMM_CD = B.SVC_DTL_CD AND LANG_CD = 'KR') AS SVC_CD_NM2
            , C.SEQ
            , C.APPR_LVL_SEQ
            , C.APPR_GRP_SEQ
			, C.APPR_SEQ
			, C.USER_ID
			, C.USER_NM
			, C.APPR_STAT_CD
			, (SELECT CMM_CD_NM FROM FOMM_CMM_CD_MT WHERE CODE_DIV='WORKFLOW_CD' AND UP_CMM_CD = 'APPR_STAT_CD' AND CMM_CD = C.APPR_STAT_CD AND LANG_CD = 'KR') AS APPR_STAT_NM
			, C.APPR_GBN_CD
			, (SELECT CMM_CD_NM FROM FOMM_CMM_CD_MT WHERE CODE_DIV='WORKFLOW_CD' AND UP_CMM_CD = 'APPR_GBN_CD' AND CMM_CD = C.APPR_GBN_CD AND LANG_CD = 'KR') AS APPR_GBN_NM

		FROM
			  SR_BASE_INFO A
			, WF_REQ_TMPLAT_HT B
			, (
			  SELECT *
			  FROM
			    (
			    SELECT
			          C.*
                    , DENSE_RANK() OVER(PARTITION BY REQ_ID, WF_PROC_CD, APPR_LVL_SEQ, APPR_GRP_SEQ ORDER BY APPR_SEQ) AS RNK
			    FROM
			        WF_APPROVAL_MT C

			    WHERE 1 = 1
			    AND APPR_STAT_CD = 'APST_01'
			    AND APPR_LVL_SEQ =
			                        (
			                        SELECT MIN(APPR_LVL_SEQ)
			                          FROM WF_APPROVAL_MT
			                          WHERE 1 = 1
			                          AND REQ_ID         = C.REQ_ID
			                          AND WF_PROC_CD     = C.WF_PROC_CD
									  AND APPR_STAT_CD   = C.APPR_STAT_CD
			                        )
			    )
			  WHERE RNK = 1
			  ) C
			, SR_WF_PROC D

		WHERE 1 = 1
		AND A.REQ_TMPLAT_ID       = B.REQ_TMPLAT_ID
		AND A.REQ_TMPLAT_VER      = B.REQ_TMPLAT_VER
		AND NOT(LENGTH(A.REQ_ID) = 14 AND INSTR(A.REQ_ID, 'B') = 1 AND A.TITLE = 'JOB PASS 배치 에러 작업')
		AND A.REQ_ID              = C.REQ_ID
		AND A.WF_PROC_CD          = C.WF_PROC_CD
		AND A.REQ_ID              = D.REQ_ID
		AND A.WF_PROC_CD          = D.WF_PROC_CD
		AND NVL(A.DEL_YN, 'N')    = 'N'
		AND A.REQ_STAT_CD         = 'RQST11'	-- 결재중
		AND C.USER_ID             = #{USER_ID}

		<if test="REQ_ID != '' and REQ_ID != null">
			AND A.REQ_ID = #{REQ_ID}
		</if>

        <if test="SEQ != '' and SEQ != null">
            AND C.SEQ = #{SEQ}
        </if>

		<if test="WF_PROC_CD != '' and WF_PROC_CD != null">
			AND	A.WF_PROC_CD = #{WF_PROC_CD}
		</if>
	    <if test="SVC_CD != '' and SVC_CD != null">
            AND B.SVC_CD = #{SVC_CD}
        </if>
        <if test="SVC_DTL_CD != '' and SVC_DTL_CD != null">
            AND B.SVC_DTL_CD = #{SVC_DTL_CD}
        </if>
        <if test="REQ_TMPLAT_NM != '' and REQ_TMPLAT_NM != null">
            AND UPPER(B.REQ_TMPLAT_NM) LIKE UPPER('%' || #{REQ_TMPLAT_NM} || '%')
        </if>
        <if test="TITLE != '' and TITLE != null">
            AND UPPER(A.TITLE) LIKE UPPER('%' || #{TITLE} || '%')
        </if>
		
		<!-- ORDER BY A.REQ_EM_YN DESC, A.FRDT DESC  -->
		ORDER BY A.REQ_DATE DESC
    </select>
    
    
    <!-- SPP 결재함 결재자 목록 조회 -->
    <select id="select02" parameterType="java.util.Map" resultType="java.util.Map">
    	/* SR0140WDAO >> select02 */
    	SELECT
              A.REQ_ID
			, A.WF_PROC_CD
			, A.SEQ
			, CASE WHEN A.SEQ = #{SEQ} THEN 'Y' ELSE 'N' END AS CUR_APV_YN
			, A.APPR_LVL_SEQ
            , A.APPR_GRP_SEQ
			, A.APPR_SEQ
			, A.APPR_STAT_CD
			, A.APPR_GBN_CD
			, A.USER_ID
			, A.USER_NM
			, A.DEPT_CD
			, A.DEPT_NM
			, A.POS_NM
			, A.APPR_STIME
			, A.APPR_DESC
			, A.APV_BTN_YN
            , A.RTRN_BTN_YN
            , A.SAVE_BTN_YN
            , A.APV_BTN_TEXT
            , A.RTRN_BTN_TEXT
            , A.SAVE_BTN_TEXT
            , B.APV_ESS_YN
            , B.RTRN_ESS_YN
            , A.ROLE_CD
            , A.DIRECT_YN
			, A.DAEJIC_USER_ID
			, A.DAEJIC_USER_NM
			, A.DAEJIC_DEPT_CD
			, A.DAEJIC_DEPT_NM
			, A.DAEJIC_POS_NM
			, A.REG_TIME

        FROM
              WF_APPROVAL_MT A
            , (
              SELECT
                  WF_PROC_CD
                , APV_ESS_YN
                , RTRN_ESS_YN

              FROM
                WF_REQ_TMPLAT_PROC_HT A
			
              WHERE 1 = 1
              AND EXISTS
				        (
				        SELECT 1
				        FROM
				            SR_BASE_INFO B
				        WHERE 1 = 1
				        AND A.REQ_TMPLAT_ID     = B.REQ_TMPLAT_ID
				        AND A.REQ_TMPLAT_VER    = B.REQ_TMPLAT_VER
				        AND B.REQ_ID            = #{REQ_ID}
	                    )
              ) B

		WHERE 1 = 1
		AND A.WF_PROC_CD    = B.WF_PROC_CD
        AND A.REQ_ID        = #{REQ_ID}
		AND	A.WF_PROC_CD    = #{WF_PROC_CD}
		AND A.APPR_LVL_SEQ  = #{APPR_LVL_SEQ}
		AND A.APPR_GRP_SEQ  = #{APPR_GRP_SEQ}

		ORDER BY A.APPR_SEQ ASC
    </select>

    <select id="select03" parameterType="java.util.Map" resultType="java.util.Map">
        /* SR0140WDAO >> select03 */
        SELECT
              APPR_LVL_SEQ
            , APPR_GRP_SEQ
        FROM WF_APPROVAL_MT
        WHERE 1 = 1
        AND REQ_ID      = #{REQ_ID}
        AND WF_PROC_CD  = #{WF_PROC_CD}
        AND SEQ         = #{SEQ}
    </select>

</mapper>