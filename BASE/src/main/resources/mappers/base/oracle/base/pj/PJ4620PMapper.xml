<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.base.pj.dao.PJ4620PDAO">

	<select id="select01" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT
			  '0' AS CHK
			, A.PRG_ID
			, A.PRG_NO
			, A.PRG_NAME
			, A.PRG_TYPE_CD
			, A.PJT_ID
			, A.BIZ_ID
			, D.BIZ_NAME
			, A.PLAN_SDATE
			, A.PLAN_EDATE
			, A.ACTL_SDATE
			, A.ACTL_EDATE
			, A.CHG_USER_NM
			, A.DEV_USER_ID
			, A.DEV_USER_NM
			, A.DEV_USER_DEPT
			, A.PL_USER_ID
			, A.PL_USER_NM
			, A.PL_USER_DEPT
			, A.REG_STIME
			, A.REG_USER_ID
			, A.REG_USER_NM
			, A.REG_USER_DEPT
			, A.LMOD_SDATE
			, A.LMOD_USER_ID
			, A.LMOD_USER_NM
			, A.LMOD_USER_DEPT
			, A.PRG_DESC
			, A.REMARK
			, B.PJT_NAME AS PJT_NAME
			, C.PJT_ID      AS P_PJT_ID 
			, C.PJT_NAME AS P_PJT_NAME
			, E.FUNC_NO_INFO
			, E.FUNC_NAME_INFO

		FROM
			  PJ_PROGRAM A   
			, PJ_PROJECT B
			, PJ_PROJECT C
			, PJ_BIZ D
			, (
			  SELECT
				  EE.PJT_ID
				, EE.PRG_ID
				, SUBSTR(XMLAGG(XMLELEMENT(X, '¶', FF.FUNC_NO) ORDER BY FF.FUNC_NO, FF.FUNC_ID).EXTRACT('//text()').GETCLOBVAL(),2) AS FUNC_NO_INFO
				, SUBSTR(XMLAGG(XMLELEMENT(X, '¶', FF.FUNC_NAME) ORDER BY FF.FUNC_NO, FF.FUNC_ID).EXTRACT('//text()').GETCLOBVAL(),2) AS FUNC_NAME_INFO
			  FROM
			  	  PJ_PRG_FUNC_MAP EE
			  	, PJ_FUNCTION FF
			  WHERE 1 = 1
			  AND EE.FUNC_ID	= FF.FUNC_ID
			  AND EE.PJT_ID     = FF.PJT_ID
			  AND EE.PJT_ID     = #{SUB_PJT_ID}

			  GROUP BY
			  	EE.PJT_ID, EE.PRG_ID
			  ) E

		WHERE 1 = 1
		AND A.PJT_ID	= B.PJT_ID
		AND B.PARENT_ID	= C.PJT_ID
		AND A.PJT_ID	= D.PJT_ID
		AND A.BIZ_ID	= D.BIZ_ID
		AND A.PJT_ID	= E.PJT_ID(+)
		AND A.PRG_ID	= E.PRG_ID(+)   
		AND A.PJT_ID	= #{SUB_PJT_ID}
		
		<if test="BIZ_ID != '' and BIZ_ID != null">
		AND A.BIZ_ID	= #{BIZ_ID}
		</if>

		<if test="PRG_NO != '' and PRG_NO != null">
		AND UPPER(A.PRG_NO) LIKE '%' || UPPER(#{PRG_NO}) || '%'
		</if>

		<if test="PRG_NM != '' and PRG_NM != null">
		AND UPPER(A.PRG_NAME) LIKE '%' || UPPER(#{PRG_NM}) || '%'
		</if>

		<if test="PRG_TYPE_CD != '' and PRG_TYPE_CD != null">
		AND A.PRG_TYPE_CD	= #{PRG_TYPE_CD}
		</if>

		ORDER BY
			A.PRG_NO, A.PRG_ID
	</select>

</mapper>