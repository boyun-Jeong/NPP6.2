<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.base.pj.dao.PJ5400WDAO">

	<select id="select01" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT
			  '0'	AS CHK
			, ''	AS ROWFLAG
			, A.STEST_ID
			, A.STEST_NO
			, A.STEST_TYPE_CD
			, A.STEST_VERSION
			, A.STEST_NAME
			, A.CASE_DESC
			, A.STEP_SEQ
			, A.STEP_NO
			, A.STEP_NAME
			, A.STEP_DESC
			, A.STEP_INPUT
			, A.STEP_EXPECT
			, A.PJT_ID
			, A.BIZ_ID
			, D.BIZ_NAME
			, A.RESULT_CD
			, A.REMARK
			, A.TESTER_ID
			, A.TESTER_NM
			, A.TESTER_DEPT
			, A.TESTER_PDATE
			, A.TESTER_ADATE
			, A.PL_USER_ID
			, A.PL_USER_NM
			, A.PL_USER_DEPT
			, A.PL_TEST_PDATE
			, A.PL_TEST_ADATE
			, A.UPMU_USER_ID
			, A.UPMU_USER_NM
			, A.UPMU_USER_DEPT
			, A.UPMU_TEST_PDATE
			, A.UPMU_TEST_ADATE
			, A.REG_STIME
			, A.REG_USER_ID
			, A.REG_USER_NM
			, A.REG_USER_DEPT
			, A.LMOD_SDATE
			, A.LMOD_USER_ID
			, A.LMOD_USER_NM
			, A.LMOD_USER_DEPT
			, B.PJT_NAME AS PJT_NAME
			, C.PJT_ID   AS P_PJT_ID 
			, C.PJT_NAME AS P_PJT_NAME
			, E.SCR_NO_INFO
			, E.SCR_NAME_INFO
			, G.INF_NO_INFO
			, G.INF_NAME_INFO
			, F.BTJB_NO_INFO
			, F.BTJB_NAME_INFO
			, (
			  SELECT COUNT(1)
			  FROM PJ_ST_DEFECT X
			  WHERE 1 = 1
			  AND X.STEST_ID				= A.STEST_ID
			  AND X.PJT_ID					= A.PJT_ID
			  AND X.STDFT_RCV_CD			= 'PJSDSTB2' /* 접수유형 - 수용 */
			  AND NVL(X.STDFT_CONF_CD, ' ') != 'PJSDSTF2' /* 확인상태 - 재조치 제외 */
			  )	AS ST_DEFECT_CNT1 /* 현황 */
			, (
			  SELECT COUNT(1)
			  FROM PJ_ST_DEFECT X
			  WHERE 1 = 1
			  AND X.STEST_ID		= A.STEST_ID
			  AND X.PJT_ID			= A.PJT_ID
			  AND X.STDFT_RCV_CD	= 'PJSDSTB2' /* 접수유형 - 수용 */
			  AND X.STDFT_ACT_CD	= 'PJSDSTC2' /* 결함처리결과 - 조치완료 */
			  AND X.STDFT_CONF_CD	= 'PJSDSTF1' /* 확인상태 - 확인완료 */
			  ) AS ST_DEFECT_CNT2  /* 조치 */

		FROM
			  PJ_SCNR_TEST A   
			, PJ_PROJECT B   
			, PJ_PROJECT C
			, PJ_BIZ D
			, (
			  SELECT
				  EE.PJT_ID
				, EE.STEST_ID
				, SUBSTR(XMLAGG(XMLELEMENT(X, '¶', FF.SCR_NO) ORDER BY FF.SCR_NO, FF.SCR_ID).EXTRACT('//text()').GETCLOBVAL(),2) AS SCR_NO_INFO
				, SUBSTR(XMLAGG(XMLELEMENT(X, '¶', FF.SCR_NAME) ORDER BY FF.SCR_NO, FF.SCR_ID).EXTRACT('//text()').GETCLOBVAL(),2) AS SCR_NAME_INFO
			  FROM
			  	  PJ_STEST_SCR_MAP EE
				, PJ_SCREEN FF

			  WHERE 1 = 1
			  AND EE.SCR_ID     = FF.SCR_ID
			  AND EE.PJT_ID     = FF.PJT_ID
			  AND EE.PJT_ID     = #{SUB_PJT_ID}

			  GROUP BY
				  EE.PJT_ID
				, EE.STEST_ID
			  ) E
			, (
			  SELECT
				  EE.PJT_ID
				, EE.STEST_ID
				, SUBSTR(XMLAGG(XMLELEMENT(X, '¶', FF.BTJB_NO) ORDER BY FF.BTJB_NO, FF.BTJB_ID).EXTRACT('//text()').GETCLOBVAL(),2) AS BTJB_NO_INFO
				, SUBSTR(XMLAGG(XMLELEMENT(X, '¶', FF.BTJB_NAME) ORDER BY FF.BTJB_NO, FF.BTJB_ID).EXTRACT('//text()').GETCLOBVAL(),2) AS BTJB_NAME_INFO

			  FROM
			  	  PJ_STEST_BTJB_MAP EE
				, PJ_BATCHJOB FF

			  WHERE 1 = 1
			  AND EE.BTJB_ID   = FF.BTJB_ID
			  AND EE.PJT_ID    = FF.PJT_ID
			  AND EE.PJT_ID    = #{SUB_PJT_ID}
				
			  GROUP BY
				  EE.PJT_ID
				, EE.STEST_ID
			  ) F
			, (
			  SELECT
				  EE.PJT_ID
				, EE.STEST_ID
				, SUBSTR(XMLAGG(XMLELEMENT(X, '¶', FF.INF_NO) ORDER BY FF.INF_NO).EXTRACT('//text()').GETCLOBVAL(),2) AS INF_NO_INFO
				, SUBSTR(XMLAGG(XMLELEMENT(X, '¶', FF.INF_NAME) ORDER BY FF.INF_NO).EXTRACT('//text()').GETCLOBVAL(),2) AS INF_NAME_INFO

			  FROM
			  	  PJ_STEST_INF_MAP EE
				, PJ_INTERFACE FF

			  WHERE 1 = 1
			  AND EE.INF_ID   = FF.INF_ID
			  AND EE.PJT_ID    = FF.PJT_ID
			  AND EE.PJT_ID    = #{SUB_PJT_ID} 

			  GROUP BY
			  	  EE.PJT_ID
				, EE.STEST_ID
			  ) G

		WHERE 1 = 1
		AND A.PJT_ID	= B.PJT_ID
		AND B.PARENT_ID	= C.PJT_ID
		AND A.PJT_ID	= D.PJT_ID
		AND A.BIZ_ID	= D.BIZ_ID
		AND A.PJT_ID	= E.PJT_ID(+)
		AND A.STEST_ID	= E.STEST_ID(+)
		AND A.PJT_ID	= F.PJT_ID(+)
		AND A.STEST_ID	= F.STEST_ID(+)
		AND A.PJT_ID	= G.PJT_ID(+)
		AND A.STEST_ID	= G.STEST_ID(+)
		AND A.PJT_ID	= #{SUB_PJT_ID} 

		<if test="BIZ_ID != '' and BIZ_ID != null">
		AND A.BIZ_ID	= #{BIZ_ID}
		</if>

		<if test="STEST_NO != '' and STEST_NO != null">
		AND UPPER(A.STEST_NO) LIKE '%' || UPPER(#{STEST_NO}) || '%'
		</if>

		<if test="STEST_NM != '' and STEST_NM != null">
		AND UPPER(A.STEST_NAME) LIKE '%' || UPPER(#{STEST_NM}) || '%'
		</if>
		
		<if test="STEST_TYPE_CD != '' and STEST_TYPE_CD != null">
		AND A.STEST_TYPE_CD	= #{STEST_TYPE_CD}
		</if>

		<if test="STEST_VERSION != '' and STEST_VERSION != null">
		AND A.STEST_VERSION	= #{STEST_VERSION}
		</if>
		
		<if test="STEP_NO != '' and STEP_NO != null">
		AND UPPER(A.STEP_NO) LIKE '%' || UPPER(#{STEP_NO}) || '%'
		</if>

		<if test="STEP_NM != '' and STEP_NM != null">
		AND UPPER(A.STEP_NAME) LIKE '%' || UPPER(#{STEP_NM}) || '%'
		</if>

		<if test="TESTER_NM != '' and TESTER_NM != null">
		AND UPPER(A.TESTER_NM) LIKE '%' || UPPER(#{TESTER_NM}) || '%'
		</if>

		<if test="RESULT_CD != '' and RESULT_CD != null">
		AND A.RESULT_CD	= #{RESULT_CD}
		</if>

		ORDER BY
			A.STEST_VERSION, A.STEST_NO, A.STEP_SEQ, A.STEP_NO, A.STEST_ID
	</select>

</mapper>