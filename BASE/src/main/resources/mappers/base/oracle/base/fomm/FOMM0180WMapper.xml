<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.base.fomm.dao.FOMM0180WDAO">

	<!-- FOMM_MENU_MT 조회 -->
	<sql id="selectMenuTree">
		SELECT	  A.MENU_ID
				, A.MENU_NM
				, A.MENU_LVL
				, DECODE(A.MENU_LVL+1, 2, A.MENU_ID, TRIM(SYS_CONNECT_BY_PATH(DECODE(LEVEL, 2, UP_MENU_ID), ' '))) AS LV1_MENU_ID
				, DECODE(A.MENU_LVL+1, 2, A.MENU_NM, TRIM(SYS_CONNECT_BY_PATH(DECODE(LEVEL, 2, (SELECT B.MENU_NM FROM FOMM_MENU_MT B WHERE B.MENU_ID = A.UP_MENU_ID)), '    '))) AS LV1_MENU_NM
				, DECODE(A.MENU_LVL+1, 3, A.MENU_ID, TRIM(SYS_CONNECT_BY_PATH(DECODE(LEVEL, 3, UP_MENU_ID), ' '))) AS LV2_MENU_ID
				, DECODE(A.MENU_LVL+1, 3, A.MENU_NM, TRIM(SYS_CONNECT_BY_PATH(DECODE(LEVEL, 3, (SELECT B.MENU_NM FROM FOMM_MENU_MT B WHERE B.MENU_ID = A.UP_MENU_ID)), '    '))) AS LV2_MENU_NM
				, DECODE(A.MENU_LVL+1, 4, A.MENU_ID, TRIM(SYS_CONNECT_BY_PATH(DECODE(LEVEL, 4, UP_MENU_ID), ' '))) AS LV3_MENU_ID
				, DECODE(A.MENU_LVL+1, 4, A.MENU_NM, TRIM(SYS_CONNECT_BY_PATH(DECODE(LEVEL, 4, (SELECT B.MENU_NM FROM FOMM_MENU_MT B WHERE B.MENU_ID = A.UP_MENU_ID)), '    '))) AS LV3_MENU_NM
		FROM	FOMM_MENU_MT A
		CONNECT BY PRIOR MENU_ID = UP_MENU_ID
		START WITH UP_MENU_ID = '0'
		ORDER SIBLINGS BY A.SORT_ORDR
	</sql>
	
	
	
	<select id="select01" parameterType="java.util.Map" resultType="java.util.Map">
		 SELECT	  '0' AS CHK
		 		, '' AS ROWFLAG
				, A.SLOG_ID
				, A.MENU_ID
				, A.MENU_NM
				, MENU.LV1_MENU_ID
				, MENU.LV2_MENU_ID
				, MENU.LV3_MENU_ID
				, MENU.LV1_MENU_NM
				, MENU.LV2_MENU_NM
				, MENU.LV3_MENU_NM
				
				, A.USER_ID
				, A.USER_NAME
				, A.REG_STIME
				, SUBSTR(A.REG_STIME, 9, 6)	AS REG_HHMMSS
				, A.CLIENT_IP
				, A.SVR_IP
				, A.MENU_URL
				, A.SYYMM
				, A.SDAY
				
		FROM	  FOMM_USAGE_LOG	A
				, (
					<include refid="selectMenuTree"/> 
				  ) MENU
		WHERE 	1 = 1
		AND		A.MENU_ID = MENU.MENU_ID
		<if test="MENU_NM != '' and MENU_NM != null">
			AND UPPER(A.MENU_NM) LIKE UPPER('%'||#{MENU_NM}||'%')
		</if>
		<if test="USER_ID != '' and USER_ID != null">
			AND UPPER(A.USER_ID) LIKE UPPER('%'||#{USER_ID}||'%')
		</if>
		<if test="USER_NAME != '' and USER_NAME != null">
			AND UPPER(A.USER_NAME) LIKE UPPER('%'||#{USER_NAME}||'%')
		</if>
		<if test="START_DATE != '' and START_DATE != null">
			AND  SUBSTR(A.REG_STIME, 1, 8) <![CDATA[>=]]> #{START_DATE}
		</if>
		<if test="END_DATE != '' and END_DATE != null">
			AND  SUBSTR(A.REG_STIME, 1, 8) <![CDATA[<=]]> #{END_DATE}
		</if>
		
		ORDER BY REG_STIME DESC
	 </select>
	 
	 
	 
	 <select id="select02" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT	  MENU.LV1_MENU_ID
				, MENU.LV2_MENU_ID
				, MENU.LV3_MENU_ID
				, MENU.LV1_MENU_NM
				, MENU.LV2_MENU_NM
				, MENU.LV3_MENU_NM
				
				, A.RANK_NO
				, A.CNT
		FROM (
				SELECT	  A.MENU_ID
						, RANK() OVER(ORDER BY COUNT(0) DESC) RANK_NO
						, COUNT(0) CNT
				FROM	  FOMM_USAGE_LOG A
				WHERE 1 = 1
				<if test="MENU_NM != '' and MENU_NM != null">
					AND UPPER(MENU_NM) LIKE UPPER('%'||#{MENU_NM}||'%')
				</if>
				<if test="USER_ID != '' and USER_ID != null">
					AND UPPER(USER_ID) LIKE UPPER('%'||#{USER_ID}||'%')
				</if>
				<if test="USER_NAME != '' and USER_NAME != null">
					AND UPPER(USER_NAME) LIKE UPPER('%'||#{USER_NAME}||'%')
				</if>
				<if test="START_DATE != '' and START_DATE != null">
					AND  SUBSTR(REG_STIME, 1, 8) <![CDATA[>=]]> #{START_DATE}
				</if>
				<if test="END_DATE != '' and END_DATE != null">
					AND  SUBSTR(REG_STIME, 1, 8) <![CDATA[<=]]> #{END_DATE}
				</if>
				GROUP BY MENU_ID
			  ) A
			, (
				<include refid="selectMenuTree"/> 
			  ) MENU
		WHERE	1=1
		AND		A.MENU_ID = MENU.MENU_ID
		
		ORDER BY A.RANK_NO
	 </select>
	 
	 
	 
	 <select id="select03" parameterType="java.util.Map" resultType="java.util.Map">
		 SELECT	RANK() OVER(ORDER BY COUNT(0) DESC) RANK_NO
		     , a.USER_ID
		     , a.USER_NAME 
		     , b.DEPT_NM
		     , COUNT(0) CNT
		  FROM FOMM_USAGE_LOG a
		     , FOMM_USER_MT b
		 WHERE 1 = 1
		   AND a.USER_ID = b.USER_ID(+)
		<if test="USER_ID != '' and USER_ID != null">
			AND UPPER(a.USER_ID) LIKE UPPER('%'||#{USER_ID}||'%')
		</if>
		<if test="USER_NAME != '' and USER_NAME != null">
			AND UPPER(a.USER_NAME) LIKE UPPER('%'||#{USER_NAME}||'%')
		</if>
		<if test="START_DATE != '' and START_DATE != null">
			AND  SUBSTR(a.REG_STIME, 1, 8) <![CDATA[>=]]> #{START_DATE}
		</if>
		<if test="END_DATE != '' and END_DATE != null">
			AND  SUBSTR(a.REG_STIME, 1, 8) <![CDATA[<=]]> #{END_DATE}
		</if>
		
		 GROUP BY a.USER_ID, a.USER_NAME, b.DEPT_NM  
	 </select>
	 
</mapper>