<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.base.sr.dao.SR0130WDAO">

	<!-- SPP 처리함 목록 조회 -->
    <select id="select01" parameterType="java.util.Map" resultType="java.util.Map">
    	/* SR0130WMapper >> select01 */
		SELECT
			  '0' AS CHK
			, '' AS ROWFLAG
			, R_UPMU_ID1
            , (SELECT CMM_CD_NM FROM FOMM_CMM_CD_MT WHERE CODE_DIV = 'NHFIRE' AND UP_CMM_CD = 'BIZC0000' AND CMM_CD = R_UPMU_ID1) AS R_UPMU_NM1
            , R_UPMU_ID2
            , (SELECT CMM_CD_NM FROM FOMM_CMM_CD_MT WHERE CODE_DIV = 'NHFIRE' AND UP_CMM_CD = R_UPMU_ID1 AND CMM_CD = R_UPMU_ID2) AS R_UPMU_NM2
            , R_UPMU_ID3
            , (SELECT CMM_CD_NM FROM FOMM_CMM_CD_MT WHERE CODE_DIV = 'NHFIRE' AND UP_CMM_CD = R_UPMU_ID2 AND CMM_CD = R_UPMU_ID3) AS R_UPMU_NM3
			, A.REQ_ID			-- 요청서 ID
			, A.REQ_TMPLAT_ID	-- 요청서양식ID
			, A.REQ_TMPLAT_VER	-- 요청서양식VER
			, A.REQ_EM_YN		-- 긴급여부
			, A.WF_PROC_CD		-- 진행단계
            , REPLACE(A.WF_PROC_NM, '\n', ' ') AS WF_PROC_NM   --진행단계명
			, A.REQ_STAT_CD		-- 요청서 진행상태
			, A.REQ_STAT_NM || CASE WHEN A.LAST_RTRN_YN = 'Y' THEN '(반려)' END	AS REQ_STAT_NM	--요청서진행상태명
			, A.TITLE			-- 요청서제목
			, A.REQ_USER_ID		-- 요청자ID
			, A.REQ_USER_NM		-- 요청자명
			, A.REQ_DEPT_CD		-- 요청자부서
			, A.REQ_DEPT_NM		-- 요청자부서명
			, A.REQ_DATE		-- 요청일시
			, A.REQ_WISH_DT		-- 완료희망일
			, A.REQ_WISH_TIME	-- 완료희망 시/분
            , CASE
                WHEN A.REQ_WISH_DT IS NOT NULL
                THEN RPAD((A.REQ_WISH_DT || NVL(A.REQ_WISH_TIME, '2359')), 14, '0')
                ELSE ''
              END   AS REQ_WISH_DT_NM       -- 완료희망일시명

			, A.JOB_REQ_DT		-- 작업요청일
			, A.JOB_REQ_TIME	-- 작업요청 시/분

			, B.REQ_TMPLAT_NM	-- 요청서 양식명
			
			, (SELECT ITM_VAL_1 FROM FOMM_CMM_CD_MT WHERE CODE_DIV = 'WORKFLOW_CD' AND UP_CMM_CD = 'REQ_INFO_TYPE_CD' AND CMM_CD = B.REQ_INFO_TYPE_CD AND LANG_CD = 'KR')    AS SR_INFO_URL  --요청서 기본정보 화면 URL
			, B.REQ_URL																														--요청서URL
			, B.ATTACH_USE_YN																												--첨부파일 사용여부
			, B.SVC_CD			-- 서비스
			, B.SVC_DTL_CD		-- 서비스상세
			
			, (SELECT CMM_CD_NM FROM FOMM_CMM_CD_MT WHERE CODE_DIV = 'WORKFLOW_CD' AND UP_CMM_CD = 'SVC_CD' AND CMM_CD = B.SVC_CD AND LANG_CD = 'KR')
              ||
              CASE
                WHEN B.SVC_DTL_CD IS NOT NULL
                THEN
                    ' > '|| (SELECT CMM_CD_NM FROM FOMM_CMM_CD_MT WHERE CODE_DIV = 'WORKFLOW_CD' AND UP_CMM_CD = B.SVC_CD AND CMM_CD = B.SVC_DTL_CD AND LANG_CD = 'KR')
              END   AS SVC_CD_NM    -- 서비스 > 서비스상세
            , (SELECT CMM_CD_NM FROM FOMM_CMM_CD_MT WHERE CODE_DIV = 'WORKFLOW_CD' AND UP_CMM_CD = 'SVC_CD' AND CMM_CD = B.SVC_CD AND LANG_CD = 'KR') AS SVC_CD_NM1
            , (SELECT CMM_CD_NM FROM FOMM_CMM_CD_MT WHERE CODE_DIV = 'WORKFLOW_CD' AND UP_CMM_CD = B.SVC_CD AND CMM_CD = B.SVC_DTL_CD AND LANG_CD = 'KR') AS SVC_CD_NM2
            , ( CASE WHEN SUBSTR(A.REQ_ID, 1, 3) = 'SRM' THEN (SELECT AGREE_COMP_DT FROM WF_SRM WHERE REQ_ID = A.REQ_ID)
                          WHEN SUBSTR(A.REQ_ID, 1, 3) = 'CHM' THEN (SELECT AGREE_COMP_EDT FROM WF_CHM WHERE REQ_ID = A.REQ_ID)
                          WHEN SUBSTR(A.REQ_ID, 1, 3) = 'PBM' THEN (SELECT AGREE_COMP_EDT FROM WF_PBM WHERE REQ_ID = A.REQ_ID)
                          ELSE '' END) AS AGREE_COMP_EDT

			, CASE
					WHEN A.WF_PROC_CD = 'WF_PROC_1000' AND A.REQ_STAT_CD IN ('RQST00', 'RQST91')
					THEN 1
					ELSE
						CASE
							WHEN A.PROC_COMP_DATE IS NOT NULL
              				THEN
              					CASE              	
					                WHEN
					                	SUBSTR(A.PROC_COMP_DATE, 1, 8) >
					                	CASE
											WHEN SUBSTR(A.REQ_ID, 1, 3) = 'SRM' THEN NVL((SELECT AGREE_COMP_DT FROM WF_SRM WHERE REQ_ID = A.REQ_ID), A.REQ_WISH_DT)
											WHEN SUBSTR(A.REQ_ID, 1, 3) = 'CHM' THEN NVL((SELECT AGREE_COMP_EDT FROM WF_CHM WHERE REQ_ID = A.REQ_ID), A.REQ_WISH_DT)
											WHEN SUBSTR(A.REQ_ID, 1, 3) = 'PBM' THEN NVL((SELECT AGREE_COMP_EDT FROM WF_PBM WHERE REQ_ID = A.REQ_ID), A.REQ_WISH_DT)
										  END
					                THEN -1
					                ELSE 1
								END
							ELSE
								CASE              	
					                WHEN
					                	TO_CHAR(SYSDATE, 'YYYYMMDD') >
					                	CASE
											WHEN SUBSTR(A.REQ_ID, 1, 3) = 'SRM' THEN NVL((SELECT AGREE_COMP_DT FROM WF_SRM WHERE REQ_ID = A.REQ_ID), A.REQ_WISH_DT)
											WHEN SUBSTR(A.REQ_ID, 1, 3) = 'CHM' THEN NVL((SELECT AGREE_COMP_EDT FROM WF_CHM WHERE REQ_ID = A.REQ_ID), A.REQ_WISH_DT)
											WHEN SUBSTR(A.REQ_ID, 1, 3) = 'PBM' THEN NVL((SELECT AGREE_COMP_EDT FROM WF_PBM WHERE REQ_ID = A.REQ_ID), A.REQ_WISH_DT)
										END
									THEN -1
									WHEN
										TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN
										CASE
											WHEN SUBSTR(A.REQ_ID, 1, 3) = 'SRM' THEN NVL((SELECT AGREE_COMP_DT FROM WF_SRM WHERE REQ_ID = A.REQ_ID), A.REQ_WISH_DT)
											WHEN SUBSTR(A.REQ_ID, 1, 3) = 'CHM' THEN NVL((SELECT AGREE_COMP_EDT FROM WF_CHM WHERE REQ_ID = A.REQ_ID), A.REQ_WISH_DT)
											WHEN SUBSTR(A.REQ_ID, 1, 3) = 'PBM' THEN NVL((SELECT AGREE_COMP_EDT FROM WF_PBM WHERE REQ_ID = A.REQ_ID), A.REQ_WISH_DT)
										END - 1 AND
										CASE
											WHEN SUBSTR(A.REQ_ID, 1, 3) = 'SRM' THEN NVL((SELECT AGREE_COMP_DT FROM WF_SRM WHERE REQ_ID = A.REQ_ID), A.REQ_WISH_DT)
											WHEN SUBSTR(A.REQ_ID, 1, 3) = 'CHM' THEN NVL((SELECT AGREE_COMP_EDT FROM WF_CHM WHERE REQ_ID = A.REQ_ID), A.REQ_WISH_DT)
											WHEN SUBSTR(A.REQ_ID, 1, 3) = 'PBM' THEN NVL((SELECT AGREE_COMP_EDT FROM WF_PBM WHERE REQ_ID = A.REQ_ID), A.REQ_WISH_DT)
										END
									THEN 0
									ELSE 1
								END
              			END
			  END	AS DUE_CHK
		FROM
			(
			SELECT
				  A.*
				, CASE
                    WHEN SUBSTR(A.REQ_ID, 1, 3) = 'SRM' THEN SRM.UPMU_ID1
                    WHEN SUBSTR(A.REQ_ID, 1, 3) = 'CHM' THEN CHM.UPMU_ID1
                    WHEN SUBSTR(A.REQ_ID, 1, 3) = 'PBM' THEN PBM.UPMU_ID1
                    WHEN SUBSTR(A.REQ_ID, 1, 3) = 'ICM' THEN ICM.UPMU_ID1
                    WHEN INSTR(A.REQ_ID, 'B') = 1 THEN BACH.UPMU_ID1
                  END AS R_UPMU_ID1
                , CASE
                    WHEN SUBSTR(A.REQ_ID, 1, 3) = 'SRM' THEN SRM.UPMU_ID2
                    WHEN SUBSTR(A.REQ_ID, 1, 3) = 'CHM' THEN CHM.UPMU_ID2
                    WHEN SUBSTR(A.REQ_ID, 1, 3) = 'PBM' THEN PBM.UPMU_ID2
                    WHEN SUBSTR(A.REQ_ID, 1, 3) = 'ICM' THEN ICM.UPMU_ID2
                    WHEN INSTR(A.REQ_ID, 'B') = 1 THEN BACH.UPMU_ID2
                  END AS R_UPMU_ID2
                , CASE
                    WHEN SUBSTR(A.REQ_ID, 1, 3) = 'SRM' THEN SRM.UPMU_ID3
                    WHEN SUBSTR(A.REQ_ID, 1, 3) = 'CHM' THEN CHM.UPMU_ID3
                    WHEN SUBSTR(A.REQ_ID, 1, 3) = 'PBM' THEN PBM.UPMU_ID3
                    WHEN SUBSTR(A.REQ_ID, 1, 3) = 'ICM' THEN ICM.UPMU_ID3
                    WHEN INSTR(A.REQ_ID, 'B') = 1 THEN BACH.UPMU_ID3
                  END AS R_UPMU_ID3
				, DECODE
				  (
				  	NVL(A.WF_PROC_CD, 'WF_PROC_1000'), 'WF_PROC_1000', 'WF_PROC_1000', 	-- 등록 > 등록
													   'WF_PROC_9999', 'WF_PROC_9999',	-- 종료 > 종료
					(SELECT UP_CMM_CD FROM FOMM_CMM_CD_MT WHERE CODE_DIV = 'WORKFLOW_CD' AND UP_CMM_CD = 'WF_PROC_CD' AND CMM_CD = A.WF_PROC_CD AND LANG_CD = 'KR')		-- 상위단계코드
				  ) AS UP_WF_PROC_CD			-- 상위 단계 코드 
			FROM
				  SR_BASE_INFO A
				, WF_SRM SRM
				, WF_CHM CHM
				, WF_PBM PBM
				, WF_ICM ICM
				, WF_BACH BACH

			WHERE 1 = 1
			AND A.REQ_ID	= SRM.REQ_ID(+)
			AND A.REQ_ID	= CHM.REQ_ID(+)
			AND A.REQ_ID	= PBM.REQ_ID(+)
			AND A.REQ_ID	= ICM.PROC_NUMBER(+)
			AND A.REQ_ID	= BACH.REQ_ID(+)
			AND NVL(DEL_YN, 'N') = 'N'
			AND NOT(LENGTH(A.REQ_ID) = 14 AND INSTR(A.REQ_ID, 'B') = 1 AND A.TITLE = 'JOB PASS 배치 에러 작업')
			) A,
			WF_REQ_TMPLAT_HT B

		WHERE 1 = 1
		AND A.REQ_TMPLAT_ID   = B.REQ_TMPLAT_ID
		AND A.REQ_TMPLAT_VER  = B.REQ_TMPLAT_VER

		AND A.DEL_YN = 'N'

		AND EXISTS
				(
				SELECT 1
				FROM
					SR_CGER_DT D
				WHERE 1 = 1
				AND (D.WF_FUNC_CD = 'WF_FUNC_04' AND A.REQ_STAT_CD IN ('RQST00', 'RQST01', 'RQST91'))	-- 담당자;	임시저장, 등록, 반려
				AND D.REQ_ID		= A.REQ_ID 
				AND D.WF_PROC_CD	= A.WF_PROC_CD 
				AND D.USER_ID       = #{USER_ID}
				)

		<if test="SVC_CD != '' and SVC_CD != null">
        AND	B.SVC_CD = #{SVC_CD}
        </if>

        <if test="SVC_DTL_CD != '' and SVC_DTL_CD != null">
        AND	B.SVC_DTL_CD = #{SVC_DTL_CD}
        </if>

        <if test="REQ_TMPLAT_NM != '' and REQ_TMPLAT_NM != null">
        AND	UPPER(B.REQ_TMPLAT_NM) LIKE UPPER('%' || #{REQ_TMPLAT_NM} || '%')
        </if>

        <if test="TITLE != '' and TITLE != null">
        AND	UPPER(A.TITLE) LIKE UPPER('%' || #{TITLE} || '%')
        </if>

        <if test="REQ_EM_YN != '' and REQ_EM_YN != null">
        AND	A.REQ_EM_YN = #{REQ_EM_YN}
        </if>

		<if test="DEADLINE != '' and DEADLINE != null">
		AND NOT(A.WF_PROC_CD = 'WF_PROC_9999' OR (A.WF_PROC_CD = 'WF_PROC_1000' AND A.REQ_STAT_CD IN ('RQST00', 'RQST91')) )
		AND A.PROC_COMP_DATE IS NULL
		AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN
					CASE
						WHEN SUBSTR(A.REQ_ID, 1, 3) = 'SRM' THEN NVL((SELECT AGREE_COMP_DT FROM WF_SRM WHERE REQ_ID = A.REQ_ID), A.REQ_WISH_DT)
						WHEN SUBSTR(A.REQ_ID, 1, 3) = 'CHM' THEN NVL((SELECT AGREE_COMP_EDT FROM WF_CHM WHERE REQ_ID = A.REQ_ID), A.REQ_WISH_DT)
						WHEN SUBSTR(A.REQ_ID, 1, 3) = 'PBM' THEN NVL((SELECT AGREE_COMP_EDT FROM WF_PBM WHERE REQ_ID = A.REQ_ID), A.REQ_WISH_DT)
					END - 1 AND
					CASE
						WHEN SUBSTR(A.REQ_ID, 1, 3) = 'SRM' THEN NVL((SELECT AGREE_COMP_DT FROM WF_SRM WHERE REQ_ID = A.REQ_ID), A.REQ_WISH_DT)
						WHEN SUBSTR(A.REQ_ID, 1, 3) = 'CHM' THEN NVL((SELECT AGREE_COMP_EDT FROM WF_CHM WHERE REQ_ID = A.REQ_ID), A.REQ_WISH_DT)
						WHEN SUBSTR(A.REQ_ID, 1, 3) = 'PBM' THEN NVL((SELECT AGREE_COMP_EDT FROM WF_PBM WHERE REQ_ID = A.REQ_ID), A.REQ_WISH_DT)
					END
	   </if> 
	   
		<if test="DELAY != '' and DELAY != null">
		AND NOT(A.WF_PROC_CD = 'WF_PROC_1000' AND A.REQ_STAT_CD IN ('RQST00', 'RQST91') )
		AND (
				 (A.PROC_COMP_DATE IS NOT NULL AND SUBSTR(A.PROC_COMP_DATE, 1, 8) >
				 CASE
						WHEN SUBSTR(A.REQ_ID, 1, 3) = 'SRM' THEN NVL((SELECT AGREE_COMP_DT FROM WF_SRM WHERE REQ_ID = A.REQ_ID), A.REQ_WISH_DT)
						WHEN SUBSTR(A.REQ_ID, 1, 3) = 'CHM' THEN NVL((SELECT AGREE_COMP_EDT FROM WF_CHM WHERE REQ_ID = A.REQ_ID), A.REQ_WISH_DT)
						WHEN SUBSTR(A.REQ_ID, 1, 3) = 'PBM' THEN NVL((SELECT AGREE_COMP_EDT FROM WF_PBM WHERE REQ_ID = A.REQ_ID), A.REQ_WISH_DT)
				 END
				 ) OR
				 (A.PROC_COMP_DATE IS NULL AND TO_CHAR(SYSDATE, 'YYYYMMDD') >
				 CASE
						WHEN SUBSTR(A.REQ_ID, 1, 3) = 'SRM' THEN NVL((SELECT AGREE_COMP_DT FROM WF_SRM WHERE REQ_ID = A.REQ_ID), A.REQ_WISH_DT)
						WHEN SUBSTR(A.REQ_ID, 1, 3) = 'CHM' THEN NVL((SELECT AGREE_COMP_EDT FROM WF_CHM WHERE REQ_ID = A.REQ_ID), A.REQ_WISH_DT)
						WHEN SUBSTR(A.REQ_ID, 1, 3) = 'PBM' THEN NVL((SELECT AGREE_COMP_EDT FROM WF_PBM WHERE REQ_ID = A.REQ_ID), A.REQ_WISH_DT)
				 END
				 )
				)
	   </if>

		ORDER BY
			A.REQ_DATE DESC, A.REQ_ID DESC
	</select>

</mapper>