<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.base.pj.dao.PJ5700PDAO">

	<select id="select01" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT
			  A.STDFT_ID
			, A.STEST_ID
			, E.STEST_TYPE_CD
			, E.STEST_VERSION
			, E.CASE_DESC
			, E.STEP_SEQ
			, E.STEST_NO
			, E.STEST_NAME
			, E.STEP_NO
			, E.STEP_NAME
			, A.PJT_ID
			, A.BIZ_ID
			, D.BIZ_NAME
			, A.STDFT_NO
			, A.STDFT_NAME
			, A.STDFT_TYPE_CD
			, A.STDFT_DESC
			, A.STDFT_RCV_CD
			, A.STDFT_RCV_DESC
			, A.STDFT_ACT_CD
			, A.STDFT_CLASS_CD
			, A.STDFT_SEVERITY_CD
			, A.STDFT_CONF_CD
			, A.DFT_USER_ID
			, A.DFT_USER_NM
			, A.DFT_USER_DEPT
			, A.DFT_REG_DATE
			, A.ACT_USER_ID
			, A.ACT_USER_NM
			, A.ACT_USER_DEPT
			, A.ACT_PDATE
			, A.ACT_ADATE
			, A.ACT_DESC
			, A.CONF_USER_ID
			, A.CONF_USER_NM
			, A.CONF_USER_DEPT
			, A.CONF_DATE
			, A.REG_STIME
			, A.REG_USER_ID
			, A.REG_USER_NM
			, A.REG_USER_DEPT
			, A.SYSMODTIME
			, A.LMOD_USER_ID
			, A.LMOD_USER_NM
			, A.LMOD_USER_DEPT
			, A.REMARK
			, B.PJT_NAME AS PJT_NAME
			, C.PJT_ID   AS P_PJT_ID 
			, C.PJT_NAME AS P_PJT_NAME

		FROM
			  PJ_ST_DEFECT A   
			, PJ_PROJECT B   
			, PJ_PROJECT C
			, PJ_BIZ D
			, PJ_SCNR_TEST E

		WHERE 1 =1
		AND A.PJT_ID					= B.PJT_ID
		AND B.PARENT_ID					= C.PJT_ID
		AND A.PJT_ID					= D.PJT_ID
		AND A.BIZ_ID					= D.BIZ_ID
		AND A.PJT_ID					= E.PJT_ID
		AND A.STEST_ID					= E.STEST_ID
		AND A.PJT_ID					= #{PJT_ID}
		AND A.BIZ_ID					= #{BIZ_ID}
		AND A.STDFT_RCV_CD    			= 'STEST_REV_CD02'		/* 접수유형 - 수용 */
		AND NVL(A.STDFT_CONF_CD, ' ')	!= 'STEST_CTYPE_CD02'	/* 확인상태 - 재조치 제외 */
		AND (
			 NVL(A.STDFT_ACT_CD, ' ')   != 'STEST_DPRC_CD02'	/* 결함처리결과 - 조치완료  제외*/ OR
			 NVL(A.STDFT_CONF_CD, ' ')	!= 'STEST_CTYPE_CD01'	/* 확인상태 - 확인완료 제외 */
			)
		AND E.STEST_TYPE_CD  = #{STEST_TYPE_CD}
		AND E.STEST_VERSION  = #{STEST_VERSION}

		<choose>
			<when test='"SUM".equals(MODE)'>
		AND A.ACT_PDATE <![CDATA[<=]]> #{BDATE}
			</when>
			<when test='"WEEK".equals(MODE)'>
		AND A.ACT_PDATE BETWEEN (SELECT /* 일요일 계산 */TO_CHAR(TO_DATE(#{BDATE},'YYYYMMDD') + (1 - TO_CHAR(TO_DATE(#{BDATE},'YYYYMMDD'),'D')), 'YYYYMMDD') FROM DUAL) AND #{BDATE}
			</when>
			<when test='"DAY".equals(MODE)'>
		AND A.ACT_PDATE = #{BDATE}
			</when>
		</choose>

		ORDER BY
			A.STDFT_NO, A.STDFT_ID
	</select>

</mapper>