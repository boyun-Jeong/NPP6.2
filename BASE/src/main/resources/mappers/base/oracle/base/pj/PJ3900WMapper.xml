<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.base.pj.dao.PJ3900WDAO">

	<select id="select01" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT
			  A.REQ_ID
			, A.REQ_NO
			, A.REQ_NAME
			, A.PJT_ID
			, A.BIZ_ID
			, D.BIZ_NAME
			, A.DLVR_NAME
			, A.CHG_ST_CD
			, A.REMARK
			, B.PJT_NAME AS PJT_NAME
			, C.PJT_ID   AS P_PJT_ID
			, C.PJT_NAME AS P_PJT_NAME
			, F.FUNC_NO_INFO
			, F.FUNC_NAME_INFO
			, S.SCR_NO_INFO
			, S.SCR_NAME_INFO
			, I.INF_NO_INFO
			, I.INF_NAME_INFO
			, J.BTJB_NO_INFO
			, J.BTJB_NAME_INFO
			, U.UTEST_NO_INFO
			, U.UTEST_NAME_INFO
			, T.STEST_NO_INFO
			, T.STEST_NAME_INFO

		FROM
			  PJ_REQMENT   A
			, PJ_PROJECT   B
			, PJ_PROJECT   C
			, PJ_BIZ       D
			, (
			  SELECT /* 기능 */
					  A.PJT_ID
					, A.REQ_ID
					, SUBSTR(XMLAGG(XMLELEMENT(X, '¶', B.FUNC_NO) ORDER BY B.FUNC_NO).EXTRACT('//text()').GETCLOBVAL(),2) AS FUNC_NO_INFO
					, SUBSTR(XMLAGG(XMLELEMENT(X, '¶', B.FUNC_NAME) ORDER BY B.FUNC_NO).EXTRACT('//text()').GETCLOBVAL(),2) AS FUNC_NAME_INFO
			  FROM
			  	  PJ_FUNC_REQ_MAP A
				, PJ_FUNCTION B

			  WHERE 1=1
			  AND A.PJT_ID	= B.PJT_ID
			  AND A.FUNC_ID	= B.FUNC_ID
			  AND A.PJT_ID	= #{SUB_PJT_ID}
			
			  GROUP BY
				A.PJT_ID, A.REQ_ID
			  ) F
			, (
			  SELECT /* 화면 */
				  C.PJT_ID
				, C.REQ_ID
				, SUBSTR(XMLAGG(XMLELEMENT(X, '¶', B.SCR_NO) ORDER BY B.SCR_NO).EXTRACT('//text()').GETCLOBVAL(),2) AS SCR_NO_INFO
				, SUBSTR(XMLAGG(XMLELEMENT(X, '¶', B.SCR_NAME) ORDER BY B.SCR_NO).EXTRACT('//text()').GETCLOBVAL(),2) AS SCR_NAME_INFO

			  FROM
			  	  PJ_SCR_FUNC_MAP A
				, PJ_SCREEN B
				, PJ_FUNC_REQ_MAP C

			  WHERE 1 = 1
			  AND A.PJT_ID	= B.PJT_ID
			  AND A.SCR_ID	= B.SCR_ID
			  AND A.PJT_ID	= C.PJT_ID
			  AND A.FUNC_ID	= C.FUNC_ID
			  AND A.PJT_ID	= #{SUB_PJT_ID}

			  GROUP BY
			  	C.PJT_ID, C.REQ_ID
			  ) S
			, (
			  SELECT
			  	  /* 인터페이스 */
				  A.PJT_ID
				, A.REQ_ID
				, SUBSTR(XMLAGG(XMLELEMENT(X, '¶', B.INF_NO) ORDER BY B.INF_NO).EXTRACT('//text()').GETCLOBVAL(),2) AS INF_NO_INFO
				, SUBSTR(XMLAGG(XMLELEMENT(X, '¶', B.INF_NAME) ORDER BY B.INF_NO).EXTRACT('//text()').GETCLOBVAL(),2) AS INF_NAME_INFO
			  FROM
			  	  PJ_INF_REQ_MAP A
				, PJ_INTERFACE B

			  WHERE 1=1
			  AND A.PJT_ID	= B.PJT_ID
			  AND A.INF_ID	= B.INF_ID
			  AND A.PJT_ID	= #{SUB_PJT_ID}

			  GROUP BY
			  	A.PJT_ID, A.REQ_ID
			  ) I
			, (
			  SELECT
			  	  /* 배치 JOB */
				  A.PJT_ID
				, A.REQ_ID
				, SUBSTR(XMLAGG(XMLELEMENT(X, '¶', B.BTJB_NO) ORDER BY B.BTJB_NO).EXTRACT('//text()').GETCLOBVAL(),2) AS BTJB_NO_INFO
				, SUBSTR(XMLAGG(XMLELEMENT(X, '¶', B.BTJB_NAME) ORDER BY B.BTJB_NO).EXTRACT('//text()').GETCLOBVAL(),2) AS BTJB_NAME_INFO

			  FROM
			  	  PJ_BTJB_REQ_MAP A
				, PJ_BATCHJOB    B

			  WHERE 1 = 1
			  AND A.PJT_ID	= B.PJT_ID
			  AND A.BTJB_ID	= B.BTJB_ID
			  AND A.PJT_ID	= #{SUB_PJT_ID}

			  GROUP BY
			  	A.PJT_ID, A.REQ_ID
			  ) J
			, (
			  SELECT
			  	  /* 단위테스트 */
				  U.PJT_ID
				, U.REQ_ID
				, SUBSTR(XMLAGG(XMLELEMENT(X, '¶', U.UTEST_NO) ORDER BY U.UTEST_NO).EXTRACT('//text()').GETCLOBVAL(),2) AS UTEST_NO_INFO
				, SUBSTR(XMLAGG(XMLELEMENT(X, '¶', U.UTEST_NAME) ORDER BY U.UTEST_NO).EXTRACT('//text()').GETCLOBVAL(),2) AS UTEST_NAME_INFO
			  FROM
				(
                SELECT
                	  /* 단위테스트 - 중복제거 */
					  U.PJT_ID
					, U.REQ_ID
					, U.UTEST_NO
					, U.UTEST_NAME
				FROM
					(
					SELECT
						  /* 단위테스트 - 화면 */
						  C.PJT_ID
						, C.REQ_ID
						, B.UTEST_NO
						, B.UTEST_NAME

					FROM
						  PJ_SCR_FUNC_MAP A
						, PJ_UNIT_TEST B
						, PJ_FUNC_REQ_MAP C

					WHERE 1 = 1
					AND A.PJT_ID     = B.PJT_ID
					AND A.SCR_ID     = B.PRG_REF_ID
					AND A.PJT_ID     = C.PJT_ID
					AND A.FUNC_ID    = C.FUNC_ID
					AND A.PJT_ID     = #{SUB_PJT_ID}
					AND B.PRG_REF_CD = 'PJUTSTB1'

					GROUP BY
						C.PJT_ID, C.REQ_ID, B.UTEST_ID, B.UTEST_NO, B.UTEST_NAME

					UNION ALL
					
					SELECT
						  /* 단위테스트 - 인터페이스 */
						  A.PJT_ID
						, A.REQ_ID
						, B.UTEST_NO
						, B.UTEST_NAME

					FROM
						  PJ_INF_REQ_MAP A
						, PJ_UNIT_TEST   B

					WHERE 1 = 1
					AND A.PJT_ID		= B.PJT_ID
					AND A.INF_ID		= B.PRG_REF_ID
					AND A.PJT_ID		= #{SUB_PJT_ID}
					AND B.PRG_REF_CD	= 'PJUTSTB3'
					) U

				GROUP BY
					U.PJT_ID, U.REQ_ID, U.UTEST_NO, U.UTEST_NAME
				) U

			  GROUP BY
				U.PJT_ID, U.REQ_ID
			  ) U
			, (
			  SELECT
				  /* 시나리오테스트 */
				  T.PJT_ID
				, T.REQ_ID
				, SUBSTR(XMLAGG(XMLELEMENT(X, '¶', T.STEST_NO) ORDER BY T.STEST_NO).EXTRACT('//text()').GETCLOBVAL(),2) AS STEST_NO_INFO
				, SUBSTR(XMLAGG(XMLELEMENT(X, '¶', T.STEST_NAME) ORDER BY T.STEST_NO).EXTRACT('//text()').GETCLOBVAL(),2) AS STEST_NAME_INFO
			  FROM
				(
                SELECT
                	  /* 시나리오테스트 - 중복제거 */
                	  T.PJT_ID
                	, T.REQ_ID
                	, T.STEST_NO
                	, MAX(T.STEST_NAME) AS STEST_NAME

				FROM
					(
                    SELECT
                    	  /* 시나리오테스트 - 인터페이스 */
                    	  A.PJT_ID
                    	, A.REQ_ID
                    	, C.STEST_NO
                    	, MAX(C.STEST_NAME) AS STEST_NAME

					FROM
						  PJ_INF_REQ_MAP   A
						, PJ_STEST_INF_MAP B
						, PJ_SCNR_TEST     C

					WHERE 1 = 1
					AND A.PJT_ID   = B.PJT_ID
					AND A.INF_ID   = B.INF_ID
					AND B.PJT_ID   = C.PJT_ID
					AND B.STEST_ID = C.STEST_ID
					AND A.PJT_ID   = #{SUB_PJT_ID}

                    GROUP BY
                    	A.PJT_ID, A.REQ_ID, C.STEST_NO

					UNION ALL

					SELECT
						  /* 시나리오테스트 - 화면 */
						  D.PJT_ID
						, D.REQ_ID
						, C.STEST_NO
						, MAX(C.STEST_NAME) AS STEST_NAME

					FROM
						  PJ_SCR_FUNC_MAP  A
						, PJ_STEST_SCR_MAP B
						, PJ_SCNR_TEST     C
						, PJ_FUNC_REQ_MAP  D

					WHERE 1 = 1
					AND A.PJT_ID   = B.PJT_ID
					AND A.SCR_ID   = B.SCR_ID
					AND B.PJT_ID   = C.PJT_ID
					AND B.STEST_ID = C.STEST_ID
					AND A.PJT_ID   = D.PJT_ID
					AND A.FUNC_ID  = D.FUNC_ID
					AND A.PJT_ID   = #{SUB_PJT_ID}

					GROUP BY
						D.PJT_ID, D.REQ_ID, C.STEST_NO

					UNION ALL

					SELECT
						  /* 시나리오테스트 - 배치JOB */
						  A.PJT_ID
						, A.REQ_ID
						, C.STEST_NO
						, MAX(C.STEST_NAME) AS STEST_NAME

					FROM
						  PJ_BTJB_REQ_MAP   A
						, PJ_STEST_BTJB_MAP B
						, PJ_SCNR_TEST      C

					WHERE 1 = 1
					AND A.PJT_ID   = B.PJT_ID
					AND A.BTJB_ID  = B.BTJB_ID
					AND B.PJT_ID   = C.PJT_ID
					AND B.STEST_ID = C.STEST_ID
					AND A.PJT_ID   = #{SUB_PJT_ID}

					GROUP BY
						A.PJT_ID, A.REQ_ID, C.STEST_NO 
					) T
                 GROUP BY
					T.PJT_ID, T.REQ_ID, T.STEST_NO
				  ) T
				GROUP BY T.PJT_ID, T.REQ_ID
			) T

 		WHERE 1 = 1
		AND A.PJT_ID      = B.PJT_ID
		AND B.PARENT_ID   = C.PJT_ID
		AND A.PJT_ID      = D.PJT_ID
		AND A.BIZ_ID      = D.BIZ_ID
		AND A.PJT_ID      = F.PJT_ID(+)
		AND A.REQ_ID      = F.REQ_ID(+)
		AND A.PJT_ID      = S.PJT_ID(+)
		AND A.REQ_ID      = S.REQ_ID(+)
		AND A.PJT_ID      = I.PJT_ID(+)
		AND A.REQ_ID      = I.REQ_ID(+)
		AND A.PJT_ID      = J.PJT_ID(+)
		AND A.REQ_ID      = J.REQ_ID(+)
		AND A.PJT_ID      = U.PJT_ID(+)
		AND A.REQ_ID      = U.REQ_ID(+)
		AND A.PJT_ID      = T.PJT_ID(+)
		AND A.REQ_ID      = T.REQ_ID(+)
		AND A.PJT_ID      = #{SUB_PJT_ID}
		AND A.REQ_TYPE_CD != 'REQ_CLS_CD07'

		<if test="BIZ_ID != '' and BIZ_ID != null">
		AND A.BIZ_ID		= #{BIZ_ID}
		</if>

		<if test="REQ_NO != '' and REQ_NO != null">
		AND UPPER(A.REQ_NO) LIKE '%' || UPPER(#{REQ_NO}) || '%'
		</if>
		
		<if test="REQ_NM != '' and REQ_NM != null">
		AND UPPER(A.REQ_NAME) LIKE '%' || UPPER(#{REQ_NM}) || '%'
		</if>

		<if test="CHG_ST_CD != '' and CHG_ST_CD != null">
		AND A.CHG_ST_CD	= #{CHG_ST_CD}
		</if>

		ORDER BY
			A.REQ_NO, A.REQ_ID
	</select>

</mapper>