<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.base.com.dao.FommHearimTlkMgrDAO">

	<insert id="insert01" parameterType="java.util.Map">
	   <selectKey resultType="string" keyProperty="TRAN_SQNO" order="BEFORE">
            SELECT
                NVL(MAX(FN_HEARIMTLKTRAN_MT_TRAN_SQ), NULL)
            FROM
                    (
                    SELECT 1
                    FROM FOMM_USER_MT
                    WHERE USER_ID = #{RCVR_INDN}
                    AND DECODE(SEND_TALK_YN, '1', 'Y', SEND_TALK_YN) = 'Y'
                    )
        </selectKey>
	   INSERT INTO FOMM_HEARIMTLKTRAN_MT
		(
		      TRAN_SQNO
		    , SEND_USER_ID
		    , SEND_USER_NM
		    , RCVR_INDN
		    , RCVR_INDN_NM
		    , TITLE
		    , CONTENT
		    , ADD_URL
		    , TARGET_DATE
		    , SEND_TIME
		    , MAP_PROC_CD
		    , MAP_WF_PROC_CD
		    , SEND_TARGET_YN
		    , SEND_GUBUN
		    , JOB_REV_NO
		)
		SELECT
              #{TRAN_SQNO}
            , NVL(#{SEND_USER_ID}, 'ITSM')
            , NVL((SELECT USER_NM FROM FOMM_USER_MT WHERE USER_ID = #{SEND_USER_ID}), 'ITSM')
            , USER_ID
            , USER_NM
            , #{TITLE}
            , #{CONTENT}
            , #{ADD_URL}
            , NVL(#{TARGET_DATE}, TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS'))
            , #{SEND_TIME}
            , #{MAP_PROC_CD}
            , #{MAP_WF_PROC_CD}
            , 'Y'
            , NVL(#{SEND_GUBUN}, '00')
            , #{JOB_REV_NO}
        FROM
            FOMM_USER_MT
        WHERE 1 = 1
        AND USER_ID          = #{RCVR_INDN}
        AND DECODE(SEND_TALK_YN, '1', 'Y', SEND_TALK_YN)    = 'Y'
	</insert>

    <select id="selectFommHearimtlktranMtSendTarget" resultType="HashMap">
        SELECT *
        FROM
            FOMM_HEARIMTLKTRAN_MT A
        WHERE 1 = 1
        AND SEND_TARGET_YN = 'Y'
        AND TRAN_SQNO   = #{TRAN_SQNO}
        AND A.TITLE IS NOT NULL
        AND A.CONTENT IS NOT NULL

        ORDER BY
            A.TRAN_SQNO ASC
    </select>

    <update id="updateFommHearimtlktranMtSendTime" parameterType="java.util.Map">
        UPDATE FOMM_HEARIMTLKTRAN_MT A SET
            SEND_TIME = SYSDATE
        WHERE 1 = 1
        AND SEND_TARGET_YN = 'Y'
        AND TRAN_SQNO   = #{TRAN_SQNO}
        AND A.TITLE IS NOT NULL
        AND A.CONTENT IS NOT NULL
    </update>

    <update id="updateFommHearimtlktranMtSendTargetYnN" parameterType="java.util.Map">
        UPDATE FOMM_HEARIMTLKTRAN_MT SET
            SEND_TARGET_YN = 'N'
        WHERE 1 = 1
        AND SEND_TARGET_YN = 'Y'
        AND TRAN_SQNO   = #{TRAN_SQNO}
    </update>

</mapper>