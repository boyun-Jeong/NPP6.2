<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.base.sr.dao.SR0141WDAO">

	<!-- SPP 검토함 목록 조회 -->
    <select id="select01" parameterType="java.util.Map" resultType="java.util.Map">
    	/* SR0141WMapper >> select01 */
	    SELECT
			  '0' AS CHK
			, '' AS ROWFLAG
			, A.REQ_ID			-- 요청서 ID
			, A.REQ_TMPLAT_ID	-- 요청서양식ID
			, A.REQ_TMPLAT_VER	-- 요청서양식VER
			, A.REQ_EM_YN		-- 긴급여부
			, 'APST_02' AS APPR_STAT_CD		-- 결재상태; 검토대기
			, A.WF_PROC_CD		-- 진행단계
			, NVL((SELECT CMM_CD_NM FROM FOMM_CMM_CD_MT WHERE CODE_DIV = 'WORKFLOW_CD' AND CMM_CD = A.WF_PROC_CD AND LANG_CD = #{SEL_LANG_CD}),
				  (SELECT CMM_CD_NM FROM FOMM_CMM_CD_MT WHERE CODE_DIV = 'WORKFLOW_CD' AND CMM_CD = A.WF_PROC_CD AND LANG_CD = #{SYS_LANG_CD})
			  )	AS WF_PROC_NM				--진행단계명
			, A.REQ_STAT_CD		-- 요청서 진행상태
			, A.REQ_STAT_NM || CASE WHEN A.LAST_RTRN_YN = 'Y' THEN '(반려)' END	AS REQ_STAT_NM	--요청서진행상태명
			, A.TITLE			-- 요청서제목
			, A.REQ_USER_ID		-- 요청자ID
			, A.REQ_USER_NM		-- 요청자명
			, A.REQ_DEPT_CD		-- 요청자부서
			, A.REQ_DEPT_NM		-- 요청자부서명
			, A.REQ_DATE		-- 요청일시
			, A.REQ_WISH_DT		-- 완료희망일
			, A.REQ_WISH_TIME	-- 완료희망 시/분
            , CASE
                WHEN A.REQ_WISH_DT IS NOT NULL
                THEN RPAD((A.REQ_WISH_DT || NVL(A.REQ_WISH_TIME, '2359')), 14, '0')
                ELSE ''
              END   AS REQ_WISH_DT_NM       -- 완료희망일시명
			
			, A.JOB_REQ_DT		-- 작업요청일
			, A.JOB_REQ_TIME	-- 작업요청 시/분
      
			, B.REQ_TMPLAT_NM	-- 요청서 양식명
			, (SELECT ITM_VAL_1 FROM FOMM_CMM_CD_MT WHERE UP_CMM_CD = 'REQ_INFO_TYPE_CD' AND CMM_CD = B.REQ_INFO_TYPE_CD AND LANG_CD = #{SYS_LANG_CD})	AS SR_INFO_URL	--요청서 기본정보 화면 URL
			, B.REQ_URL																														--요청서URL
			, B.ATTACH_USE_YN																												--첨부파일 사용여부
			, B.SVC_CD			-- 서비스
			, B.SVC_DTL_CD		-- 서비스상세
			, (NVL((SELECT CMM_CD_NM FROM FOMM_CMM_CD_MT WHERE CODE_DIV = 'WORKFLOW_CD' AND CMM_CD = B.SVC_CD AND LANG_CD = #{SEL_LANG_CD}),
				   (SELECT CMM_CD_NM FROM FOMM_CMM_CD_MT WHERE CODE_DIV = 'WORKFLOW_CD' AND CMM_CD = B.SVC_CD AND LANG_CD = #{SYS_LANG_CD})
			   ) ||
			   NVL2(B.SVC_DTL_CD, (' > '|| NVL( (SELECT CMM_CD_NM FROM FOMM_CMM_CD_MT WHERE CODE_DIV = 'WORKFLOW_CD' AND CMM_CD = B.SVC_DTL_CD AND LANG_CD = #{SEL_LANG_CD}),
			   					  				(SELECT CMM_CD_NM FROM FOMM_CMM_CD_MT WHERE CODE_DIV = 'WORKFLOW_CD' AND CMM_CD = B.SVC_DTL_CD AND LANG_CD = #{SYS_LANG_CD}))),
			   '')
			  ) AS SVC_CD_NM	-- 서비스 > 서비스상세

		FROM
			(
			SELECT
				  A.*
				, DECODE(NVL(A.WF_PROC_CD, 'WF_PROC_1000'), 'WF_PROC_1000', 'WF_PROC_1000', 	-- 등록 > 등록
															'WF_PROC_9999',	'WF_PROC_9999',		-- 종료 > 종료
						 (SELECT UP_CMM_CD FROM FOMM_CMM_CD_MT WHERE CODE_DIV = 'WORKFLOW_CD' AND CMM_CD = A.WF_PROC_CD AND LANG_CD = #{SYS_LANG_CD})		-- 상위단계코드
				  ) AS UP_WF_PROC_CD			-- 상위 단계 코드 
			FROM
				SR_BASE_INFO A
			) A,
			WF_REQ_TMPLAT_HT B

		WHERE 1 = 1
		AND A.REQ_TMPLAT_ID		= B.REQ_TMPLAT_ID
		AND A.REQ_TMPLAT_VER	= B.REQ_TMPLAT_VER
		AND NVL(A.DEL_YN, 'N')	= 'N'
		AND A.REQ_STAT_CD = 'RQST21' -- 검토중

		--잔여 검토 처리할 건수가 넘은 내역만
		AND (
            SELECT COUNT(*) AS CNT	--총 검토 해야할 건수
            FROM WF_APPROVAL_MT AP
            WHERE 1 = 1
            AND AP.REQ_ID		= A.REQ_ID
            AND	AP.WF_PROC_CD	= A.WF_PROC_CD
            AND	AP.APPR_STAT_CD	= 'APST_99'		-- 승인
            ) <![CDATA[<]]>
					(
                    SELECT RVER_CNT
                    FROM WF_REQ_TMPLAT_PROC_HT C
                    WHERE 1 = 1
                    AND C.REQ_TMPLAT_ID		= A.REQ_TMPLAT_ID
                    AND C.REQ_TMPLAT_VER	= A.REQ_TMPLAT_VER
                    AND C.WF_PROC_CD		= A.WF_PROC_CD
                    )

        AND --총 검토 해야할 건수
            (
            SELECT RVER_CNT
            FROM WF_REQ_TMPLAT_PROC_HT X
            WHERE 1 = 1
            AND X.REQ_TMPLAT_ID		= A.REQ_TMPLAT_ID
            AND X.REQ_TMPLAT_VER	= A.REQ_TMPLAT_VER
            AND X.WF_PROC_CD		= A.WF_PROC_CD
            ) -
            -- 필수 검토해야 할 건수
            (
             SELECT COUNT(*)
             FROM SR_CGER_DT X
             WHERE 1 = 1
             AND X.REQ_ID       = A.REQ_ID
             AND X.REQ_ID       = A.WF_PROC_CD
             AND X.WF_FUNC_CD   = 'WF_FUNC_02'
             AND X.ESS_YN       = 'Y'
            )
            - 
            --필수가 검토자가 아닌 승인자의 처리 건수
             (
             SELECT COUNT(*)
             FROM
                SR_CGER_DT X,
                WF_APPROVAL_MT Y
             WHERE 1 = 1
             AND X.REQ_ID       = Y.REQ_ID
             AND X.WF_PROC_CD   = Y.WF_PROC_CD
             AND X.USER_ID      = Y.USER_ID
             AND X.WF_PROC_CD   = 'WF_FUNC_02'
             AND X.ESS_YN <![CDATA[<>]]> 'Y'
             AND Y.APPR_STAT_CD = 'APST_99'
             ) > 0

        AND (
             --필수 검토자에 해당하는 경우
             #{USER_ID} IN
             (
             SELECT
                     C.USER_ID
                FROM
                      SR_CGER_DT C
                WHERE 1 = 1
                AND C.REQ_ID        = A.REQ_ID
                AND C.WF_PROC_CD    = A.WF_PROC_CD
                AND C.WF_FUNC_CD	= 'WF_FUNC_02'
                AND C.ESS_YN        = 'Y'
                --승인 건은 제외
                AND NOT EXISTS
                            (
                            SELECT 1
                            FROM WF_APPROVAL_MT D
                            WHERE 1 = 1
                            AND D.REQ_ID        = C.REQ_ID
                            AND D.WF_PROC_CD    = C.WF_PROC_CD
                            AND D.USER_ID       = C.USER_ID
                            AND D.APPR_STAT_CD  = 'APST_99'
                            )             
             ) OR
            
             --필수 검토자가 아닌 경우
             #{USER_ID} IN
             (
             SELECT
                     C.USER_ID

                FROM
                      SR_CGER_DT C

                WHERE 1 = 1
                AND C.REQ_ID        = A.REQ_ID
                AND C.WF_PROC_CD    = A.WF_PROC_CD
                AND C.WF_FUNC_CD	= 'WF_FUNC_02'
                AND NVL(C.ESS_YN, 'N') <![CDATA[<>]]> 'Y'
                --승인 건은 제외
                AND NOT EXISTS
                            (
                            SELECT 1
                            FROM WF_APPROVAL_MT D
                            WHERE 1 = 1
                            AND D.REQ_ID        = C.REQ_ID
                            AND D.WF_PROC_CD    = C.WF_PROC_CD
                            AND D.USER_ID       = C.USER_ID
                            AND D.APPR_STAT_CD  = 'APST_99'
                            )            
             )
           )

		<if test="REQ_ID != '' and REQ_ID != null">
			AND A.REQ_ID = #{REQ_ID}
		</if>
		<if test="WF_PROC_CD != '' and WF_PROC_CD != null">
			AND	A.WF_PROC_CD = #{WF_PROC_CD}
		</if>
		
		<if test="SVC_CD != '' and SVC_CD != null">
        	AND	B.SVC_CD = #{SVC_CD}
        </if>
        <if test="SVC_DTL_CD != '' and SVC_DTL_CD != null">
        	AND	B.SVC_DTL_CD = #{SVC_DTL_CD}
        </if>
        <if test="REQ_TMPLAT_NM != '' and REQ_TMPLAT_NM != null">
        	AND	UPPER(B.REQ_TMPLAT_NM) LIKE UPPER('%' || #{REQ_TMPLAT_NM} || '%')
        </if>
        <if test="TITLE != '' and TITLE != null">
        	AND	UPPER(A.TITLE) LIKE UPPER('%' || #{TITLE} || '%')
        </if>
        <if test="REQ_EM_YN != '' and REQ_EM_YN != null">
        	AND	A.REQ_EM_YN = #{REQ_EM_YN}
        </if>
		
		ORDER BY A.REQ_EM_YN DESC, A.REQ_ID DESC
    </select>
    
    
</mapper>