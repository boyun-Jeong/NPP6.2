<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.base.fomm.dao.FOMM0110WDAO">
	
	<!-- SPP 사용자 목록 조회 -->
    <select id="select01" parameterType="java.util.Map" resultType="java.util.Map">
    	/* FOMM0110WMapper >> select01 */
        SELECT
        		  0 AS CHK		/* CHECKBOX 컬럼 */
	            , '' AS ROWFLAG		/* 행상태 표기를 위한 컬럼 */
	            , USER_ID			/* ID(사번) */
	            , USER_NM			/* 사용자명 */
	            , CO_CD				/* 회사코드 */
	            , DECODE(CO_CD, 'N01', CO_NM, '협력사')	AS CO_NM
	            , DEPT_CD			/* 부서코드 */
	            , DEPT_NM			/* 부서명 */
	            , POS_NM			/* 직급명 */
	            , ROLE_NM			/* 역할(직책)명 */
                , UPMU_NM           /* 담당업무 */
	            
	            , EMAIL_ADR			/* 이메일주소 */
	            , NVL(
					REGEXP_REPLACE(
						  TRIM(REPLACE(A.MOBILE_NUM, '-', ''))
						, CASE
							WHEN LENGTH(TRIM(REPLACE(A.MOBILE_NUM, '-', ''))) = 0 THEN '(.+)(.{4})'
							ELSE '(02|.{3})(.+)(.{4})'
						  END
						, CASE
							WHEN LENGTH(TRIM(REPLACE(A.MOBILE_NUM, '-', ''))) = 0 THEN '\1-\2'
							ELSE '\1-\2-\3'
						  END
					)
					, '-'
				  ) AS MOBILE_NUM
				, NVL(
					REGEXP_REPLACE(
						  TRIM(REPLACE(A.TELNUM, '-', ''))
						, CASE
							WHEN LENGTH(TRIM(REPLACE(A.TELNUM, '-', ''))) = 0 THEN '(.+)(.{4})'
							ELSE '(02|.{3})(.+)(.{4})'
						  END
						, CASE
							WHEN LENGTH(TRIM(REPLACE(A.TELNUM, '-', ''))) = 0 THEN '\1-\2'
							ELSE '\1-\2-\3'
						  END
					)
					, ''
				  ) AS TELNUM
	            , CASE WHEN INSTR( A.TELNUM , '02-3786')  =1 THEN SUBSTR(A.TELNUM,9,13) ELSE NVL(A.TELNUM, '-') END    TELNUM2
	            , EXPIRE_DATE		/* 계정만료일자 */
	            , USE_YN			/* 계정사용여부 */
	            
	            , RMK				/* 비고 */
	            , (SELECT USER_NM FROM FOMM_USER_MT WHERE USER_ID = A.FRID) AS FRNM				/* 최초등록자 */
	            , FRDT				/* 최초등록일시 */
	            , (SELECT USER_NM FROM FOMM_USER_MT WHERE USER_ID = A.LMID) AS LMNM				/* 최종수정자 */
	            , LMDT				/* 최종수정일시 */
	            , LMPID				/* 최종수정화면ID */
	            , LANG_CD			/* 사용자 언어코드 */
                
		FROM	  FOMM_USER_MT A
		WHERE	  1=1
		
		<if test="USE_YN != null and USE_YN != ''">
			AND A.USE_YN = #{USE_YN}
		</if>
        
        
		
        <if test="CO_NM != '' and CO_NM != null">
        	AND	UPPER(CO_NM) LIKE UPPER('%' || #{CO_NM} || '%')
        </if>
        <if test="DEPT_NM != '' and DEPT_NM != null">
        	AND	UPPER(DEPT_NM) LIKE UPPER('%' || #{DEPT_NM} || '%')
        </if>
        <if test="USER_ID != '' and USER_ID != null">
        	AND	UPPER(USER_ID) LIKE UPPER('%' || #{USER_ID} || '%')
        </if>
        <if test="USER_NM != '' and USER_NM != null">
        	AND	UPPER(USER_NM) LIKE UPPER('%' || #{USER_NM} || '%')
        </if>
        
        
        
        <if test="ARR_USER_ID != '' and ARR_USER_ID != null">
        	AND A.USER_ID IN
        	<foreach collection="ARR_USER_ID" item="userId" open="(" close=")" separator=",">
				#{userId}
			</foreach>
        </if>
        
        <if test="ARR_DEPT_CD != '' and ARR_DEPT_CD != null">
        	AND A.DEPT_CD IN
        	<foreach collection="ARR_DEPT_CD" item="deptCd" open="(" close=")" separator=",">
				#{deptCd}
			</foreach>
        </if>
        
        <if test="USER_ID_NM != '' and USER_ID_NM != null">
        	AND	( UPPER(USER_ID) LIKE UPPER(#{USER_ID_NM}) || '%' OR UPPER(USER_NM) LIKE UPPER(#{USER_ID_NM}) || '%')
        </if>
        
        <if test="SEARCH_STR != '' and SEARCH_STR != null">		
        	AND	UPPER(USER_NM || ';;' || USER_ID) LIKE UPPER('%' || #{SEARCH_STR} || '%')	/* ID/이름 통합검색 */
        </if>
        
         <if test="ROLE_CD != '' and ROLE_CD != null">        
            AND ROLE_CD = #{ROLE_CD}  /* 직책코드  */
        </if>     
        
        <if test='AUSER_FLAG == "Y"'>
            /* A사번 사용자도 함께 조회 */
        UNION ALL
	        SELECT
	                  0 AS CHK      /* CHECKBOX 컬럼 */
	                , '' AS ROWFLAG     /* 행상태 표기를 위한 컬럼 */
	                , USER_ID           /* ID(사번) */
	                , USER_NM           /* 사용자명 */
	                , CO_CD             /* 회사코드 */
	                , DECODE(CO_CD, 'N01', CO_NM, '협력사')    AS CO_NM
	                , DEPT_CD           /* 부서코드 */
	                , DEPT_NM           /* 부서명 */
	                , POS_NM            /* 직급명 */
	                , ROLE_NM           /* 역할(직책)명 */
                    , UPMU_NM           /* 담당업무 */
	                
	                , EMAIL_ADR         /* 이메일주소 */
	                , NVL(
	                    REGEXP_REPLACE(
	                          TRIM(REPLACE(A.MOBILE_NUM, '-', ''))
	                        , CASE
	                            WHEN LENGTH(TRIM(REPLACE(A.MOBILE_NUM, '-', ''))) = 0 THEN '(.+)(.{4})'
	                            ELSE '(02|.{3})(.+)(.{4})'
	                          END
	                        , CASE
	                            WHEN LENGTH(TRIM(REPLACE(A.MOBILE_NUM, '-', ''))) = 0 THEN '\1-\2'
	                            ELSE '\1-\2-\3'
	                          END
	                    )
	                    , '-'
	                  ) AS MOBILE_NUM
	                , NVL(
	                    REGEXP_REPLACE(
	                          TRIM(REPLACE(A.TELNUM, '-', ''))
	                        , CASE
	                            WHEN LENGTH(TRIM(REPLACE(A.TELNUM, '-', ''))) = 0 THEN '(.+)(.{4})'
	                            ELSE '(02|.{3})(.+)(.{4})'
	                          END
	                        , CASE
	                            WHEN LENGTH(TRIM(REPLACE(A.TELNUM, '-', ''))) = 0 THEN '\1-\2'
	                            ELSE '\1-\2-\3'
	                          END
	                    )
	                    , ''
	                  ) AS TELNUM
	                , CASE WHEN INSTR( A.TELNUM , '02-3786')  =1 THEN SUBSTR(A.TELNUM,9,13) ELSE NVL(A.TELNUM, '-') END    TELNUM2
	                , EXPIRE_DATE       /* 계정만료일자 */
	                , USE_YN            /* 계정사용여부 */
	                
	                , RMK               /* 비고 */
	                , (SELECT USER_NM FROM FOMM_USER_MT WHERE USER_ID = A.FRID) AS FRNM             /* 최초등록자 */
	                , FRDT              /* 최초등록일시 */
	                , (SELECT USER_NM FROM FOMM_USER_MT WHERE USER_ID = A.LMID) AS LMNM             /* 최종수정자 */
	                , LMDT              /* 최종수정일시 */
	                , LMPID             /* 최종수정화면ID */
	                , LANG_CD           /* 사용자 언어코드 */
	                
	        FROM      AM_AUSER_MT A
	        WHERE     1=1
	        
	        <if test="USE_YN != null and USE_YN != ''">
	            AND A.USE_YN = #{USE_YN}
	        </if>
	        
	        <if test="CO_NM != '' and CO_NM != null">
	            AND UPPER(CO_NM) LIKE UPPER('%' || #{CO_NM} || '%')
	        </if>
	        <if test="DEPT_NM != '' and DEPT_NM != null">
	            AND UPPER(DEPT_NM) LIKE UPPER('%' || #{DEPT_NM} || '%')
	        </if>
	        <if test="USER_ID != '' and USER_ID != null">
	            AND UPPER(USER_ID) LIKE UPPER('%' || #{USER_ID} || '%')
	        </if>
	        <if test="USER_NM != '' and USER_NM != null">
	            AND UPPER(USER_NM) LIKE UPPER('%' || #{USER_NM} || '%')
	        </if>
	        
	        <if test="ARR_USER_ID != '' and ARR_USER_ID != null">
	            AND A.USER_ID IN
	            <foreach collection="ARR_USER_ID" item="userId" open="(" close=")" separator=",">
	                #{userId}
	            </foreach>
	        </if>
	        
	        <if test="USER_ID_NM != '' and USER_ID_NM != null">
	            AND ( UPPER(USER_ID) LIKE UPPER(#{USER_ID_NM}) || '%' OR UPPER(USER_NM) LIKE UPPER(#{USER_ID_NM}) || '%')
	        </if>
	        
	        <if test="SEARCH_STR != '' and SEARCH_STR != null">     
	            AND UPPER(USER_NM || ';;' || USER_ID) LIKE UPPER('%' || #{SEARCH_STR} || '%')   /* ID/이름 통합검색 */
	        </if>
	        
	         <if test="ROLE_CD != '' and ROLE_CD != null">        
	            AND ROLE_CD = #{ROLE_CD}  /* 직책코드  */
	        </if>     
        </if>
        
        ORDER BY  CO_NM,USER_NM
    </select>
    
    
    <!-- SPP 사용자별 권한그룹 조회 -->
    <select id="select02" parameterType="java.util.Map" resultType="java.util.Map">
    	/* FOMM0110WMapper >> select02 */
    	SELECT		  
    			  DECODE(NVL(B.USER_ID, 'N'), 'N', '0', '1') AS AUTH_YN		/* 권한별 해당 사번 DATA가 있으면 1, 없으면 0 */
    			, DECODE(NVL(B.USER_ID, 'N'), 'N', '0', '1') AS CHK
	            , '' AS ROWFLAG			/* 행상태 표기를 위한 컬럼 */
	            , B.USER_ID				/* 사용자 사번 */
	            , A.AUTH_ID				/* 권한ID */
	            , A.AUTH_NM				/* 권한그룹명 */
	            , A.AUTH_TYPE_CD		/* 권한그룹유형코드 */
	            , A.ADMIN_YN			/* 관리자여부 */
		FROM	  FOMM_AUTH_MT A
		        , (
	                SELECT    B.USER_ID
	                        , A.AUTH_ID
	                FROM      FOMM_AUTH_USER_DT A
	                        , FOMM_USER_MT B
	                WHERE     1=1
	                AND       A.USER_ID(+) = B.USER_ID
	                AND       B.USER_ID = NVL((	SELECT	USER_ID 
	                							FROM 	FOMM_USER_MT
	                							WHERE 	USER_ID = #{SEL_USER_ID}
	                						  )
	                						  , 'NEW_USER')
		          ) B
		WHERE	  1=1
		AND		  A.AUTH_ID = B.AUTH_ID(+)
		AND		  A.USE_YN = 'Y'
		ORDER BY A.AUTH_NM
    </select>
    
    <!-- SPP 신규 사용자 추가 -->
    <insert id="insert01" parameterType="java.util.Map">
		/* FOMM0110WMapper >> insert01 */
		INSERT 
		INTO  FOMM_USER_MT
		(
			  USER_ID
			, USER_NM
			, CO_CD
			, CO_NM
			, DEPT_CD
			, DEPT_NM
			, POS_NM
			, ROLE_NM
			
			, EMAIL_ADR
			, TELNUM
			, MOBILE_NUM
			, USER_PW
			, PW_INIT_DT
			, PW_EXP_DT
			, EXPIRE_DATE
			, USE_YN
			
			, RMK
			, FRID
			, FRDT
			, LMID
			, LMDT
			, LMPID
		)
		VALUES
		(
			  #{USER_ID}
			, #{USER_NM}
			, #{CO_CD}
			, #{CO_NM}
			, #{DEPT_CD}
			, #{DEPT_NM}
			, #{POS_NM}
			, #{ROLE_NM}
			
			, #{EMAIL_ADR}
			, #{TELNUM}
			, #{MOBILE_NUM}
			, #{USER_PW}
			, #{PW_INIT_DT}
			, #{PW_EXP_DT}
			, #{EXPIRE_DATE}
			, #{USE_YN}
			
			, #{RMK}
			, #{LMID}
			, TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
			, #{LMID}
			, TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
			, #{LMPID}
		)
    </insert>
    
    <!-- SPP 사용자 수정 -->
    <update id="modify01" parameterType="java.util.Map">
    	/* FOMM0110WMapper >> modify01 */
        UPDATE	FOMM_USER_MT
        SET		USER_NM		= #{USER_NM}
			  , CO_CD		= #{CO_CD}
			  , CO_NM		= #{CO_NM}
			  , DEPT_CD		= #{DEPT_CD}
			  , DEPT_NM		= #{DEPT_NM}
			  , POS_NM		= #{POS_NM}
			  , ROLE_NM		= #{ROLE_NM}
			  , EMAIL_ADR	= #{EMAIL_ADR}
			  , TELNUM		= #{TELNUM}
			  , MOBILE_NUM	= #{MOBILE_NUM}
			  , EXPIRE_DATE	= #{EXPIRE_DATE}
			  , USE_YN		= #{USE_YN}
			  
			  , RMK			= #{RMK}
			  , LMID		= #{LMID}
			  , LMDT		= TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
			  , LMPID		= #{LMPID}
		WHERE	USER_ID = #{USER_ID}
    </update>
    
    <!-- SPP 사용자 삭제 (사용여부N처리) -->
    <update id="remove01" parameterType="java.util.Map">
    	/* FOMM0110WMapper >> remove01 */
        UPDATE	FOMM_USER_MT
        SET		USE_YN		= 'N'
			  , LMID		= #{LMID}
			  , LMDT		= TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
			  , LMPID		= #{LMPID}
		WHERE	USER_ID = #{USER_ID}
    </update>
    
    
    
    <!-- SPP 사용자별 권한그룹 추가 -->
    <insert id="insert02" parameterType="java.util.Map">
		/* FOMM0110WMapper >> insert01 */
		INSERT 
		INTO	FOMM_AUTH_USER_DT
		(
			  AUTH_ID
			, USER_ID
			, FRID	
			, FRDT	
			, LMID	
			, LMDT	
			, LMPID	
		)
		VALUES
		(
			  #{AUTH_ID}
            , #{USER_ID}
            , #{LMID}
            , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
            , #{LMID}
            , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
            , #{LMPID}
		)
    </insert>
    
    <!-- SPP 사용자별 권한그룹 삭제 -->
    <delete id="remove02" parameterType="java.util.Map">
		/* FOMM0110WMapper >> remove02 */
		DELETE 
		FROM	FOMM_AUTH_USER_DT
		WHERE	USER_ID = #{USER_ID}
		AND		AUTH_ID = #{AUTH_ID}
    </delete>
</mapper>